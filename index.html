<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live AV Map - Multi-Provider</title>
    <meta property="og:title" content="Live AV Map - Multi-Provider">
    <meta property="og:description" content="A visualization of self-driving vehicle zones for U.S. companies.">
    <meta property="og:image" content="https://self-driving-map.vercel.app/open-graph.png">
    <meta property="og:type" content="website">

    <!-- Standard SEO -->
    <meta name="description" content="Interactive map showing current and future operating zones for self-driving car companies like Waymo and Zoox.">
    <meta name="keywords" content="self-driving cars, autonomous vehicles, Waymo, Zoox, robotaxi, map, coverage, AV">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Live AV Map - Multi-Provider">
    <meta name="twitter:description" content="Interactive map showing current and future operating zones for self-driving car companies like Waymo and Zoox.">
    <meta name="twitter:image" content="https://self-driving-map.vercel.app/open-graph.png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { width: 100%; height: 100%; }
        
        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }

        /* --- CONTROLS --- */
        .controls {
            position: absolute;
            top: 20px;
            left: 50px; /* Offset from zoom controls */
            background: white;
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            z-index: 500;
            display: flex;
            gap: 5px;
        }

        .btn-toggle {
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            background: #f0f0f0;
            color: #555;
        }

        .btn-toggle:hover {
            background: #e0e0e0;
        }

        .btn-toggle.active {
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Waymo/Uber Active Color */
        .btn-toggle.active[data-target="WAYMO"] {
            background: #276EF1; /* Uber Blue */
        }

        /* Zoox Active Color */
        .btn-toggle.active[data-target="ZOOX"] {
            background: #FF9900; /* Amazon Orange */
        }

        /* --- LEGEND STYLES --- */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            z-index: 500;
            font-size: 14px;
            min-width: 180px;
        }

        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div id="loading-msg" class="loading">Loading map data...</div>
    
    <div class="controls">
        <button class="btn-toggle active" data-target="WAYMO" onclick="setDataset('WAYMO')">Waymo / Uber</button>
        <button class="btn-toggle" data-target="ZOOX" onclick="setDataset('ZOOX')">Zoox</button>
    </div>

    <div id="legend-container" class="legend">
        </div>

    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        
        const COUNTY_URL = './counties-10m.json'; 
        const STATE_URL  = './states-10m.json';   
        const CITY_URL   = './av_cities_filtered.json';  
        const CONFIG_URL = './operations.json'; 
        
        let DATASETS = {};

        const PALETTES = {
            WAYMO: {
                serving: { color: 'rgba(39, 110, 241, 0.6)', label: 'Serving Riders' },
                next:    { color: 'rgba(5, 41, 133, 0.6)',   label: 'Up Next' },
                driving: { color: 'rgba(6, 193, 103, 0.6)',  label: 'Testing / Mapping' }
            },
            ZOOX: {
                serving: { color: 'rgba(255, 153, 0, 0.7)',  label: 'Currently Serving' },
                next:    { color: 'rgba(255, 204, 128, 0.8)',label: 'Serving Soon' },
                driving: { color: 'rgba(230, 74, 25, 0.6)',  label: 'Testing' }
            }
        };

        let currentDataset = 'WAYMO';
        let globalAllCounties = []; 
        let globalAllCities = []; 
        let globalStateMap = {};

        // --- 2. MAP SETUP ---
        
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({ source: new ol.source.OSM() })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-98.5795, 39.8283]),
                zoom: 4
            })
        });

        const avZoneSource = new ol.source.Vector();
        const avZoneLayer = new ol.layer.Vector({
            source: avZoneSource,
            style: (feature) => {
                const category = feature.get('category');
                const palette = PALETTES[currentDataset];
                const styleData = palette[category] || { color: 'gray' };
                
                return new ol.style.Style({
                    fill: new ol.style.Fill({ color: styleData.color }),
                    stroke: new ol.style.Stroke({ 
                        color: styleData.color.replace(/[\d.]+\)$/, '1)'), 
                        width: 1.5 
                    })
                });
            }
        });
        map.addLayer(avZoneLayer);

        // --- 3. LOGIC ---

        function updateLegend() {
            const container = document.getElementById('legend-container');
            const palette = PALETTES[currentDataset];
            const title = currentDataset === 'WAYMO' ? 'Waymo' : 'Amazon Zoox';

            let html = `<h4>${title} Key</h4>`;
            ['serving', 'next', 'driving'].forEach(key => {
                const item = palette[key];
                html += `
                    <div class="legend-item">
                        <span class="dot" style="background: ${item.color};"></span> ${item.label}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function refreshMapLayers() {
            avZoneSource.clear();
            const activeGroup = DATASETS[currentDataset];
            const matchedFeatures = [];

            // --- A. Process US Counties ---
            globalAllCounties.forEach(feature => {
                feature.unset('category');
                const name = feature.get('name');
                const fullId = String(feature.getId()).padStart(5, '0');
                const stateFips = fullId.substring(0, 2);

                const findMatch = (list) => list.find(t => 
                    t.type === 'county' && t.name === name && globalStateMap[t.state] === stateFips
                );

                if (findMatch(activeGroup.serving)) feature.set('category', 'serving');
                else if (findMatch(activeGroup.next)) feature.set('category', 'next');
                else if (findMatch(activeGroup.driving)) feature.set('category', 'driving');

                if (feature.get('category')) matchedFeatures.push(feature);
            });

            // --- B. Process International Cities (Strict Matching) ---
            if (globalAllCities.length > 0) {
                globalAllCities.forEach(feature => {
                    feature.unset('category');
                    
                    const props = feature.getProperties();
                    // Normalize feature data to handle potential casing differences
                    const cityName = (props.NAME || props.name || "").toUpperCase();
                    const countryCode = (props.country_code || props.country || "").toUpperCase();
                    const stateName = (props.state || props.STATE || "").toUpperCase();

                    const findCityMatch = (list) => list.find(t => {
                        if (t.type !== 'city') return false;
                        
                        // 1. Check Name
                        if (t.name.toUpperCase() !== cityName) return false;
                        
                        // 2. Check Country Code (Required)
                        if (t.country_code && t.country_code.toUpperCase() !== countryCode) return false;

                        // 3. Check State (Optional in config, but strict if provided)
                        if (t.state && t.state.toUpperCase() !== stateName) return false;

                        return true;
                    });

                    if (findCityMatch(activeGroup.serving)) feature.set('category', 'serving');
                    else if (findCityMatch(activeGroup.next)) feature.set('category', 'next');
                    else if (findCityMatch(activeGroup.driving)) feature.set('category', 'driving');

                    if (feature.get('category')) matchedFeatures.push(feature);
                });
            }

            // Update Map
            if (matchedFeatures.length > 0) {
                avZoneSource.addFeatures(matchedFeatures);
                const extent = avZoneSource.getExtent();
                map.getView().fit(extent, { padding: [50, 50, 50, 50], duration: 1000 });
            }
            updateLegend();
        }

        window.setDataset = (name) => {
            currentDataset = name;
            document.querySelectorAll('.btn-toggle').forEach(btn => {
                if (btn.dataset.target === name) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            refreshMapLayers();
        };

        // --- 4. DATA LOADING ---
        const loader = document.getElementById('loading-msg');

        Promise.all([
            fetch(COUNTY_URL).then(r => r.json()),
            fetch(STATE_URL).then(r => r.json()),
            fetch(CITY_URL).then(r => r.ok ? r.json() : null).catch(() => null),
            fetch(CONFIG_URL).then(r => r.json()) // Fetch the config
        ]).then(([countyData, stateData, cityData, configData]) => {

            // 1. ASSIGN CONFIG
            DATASETS = configData;

            // 2. Process US States
            const stateFormat = new ol.format.TopoJSON({ layers: ['states'] });
            stateFormat.readFeatures(stateData).forEach(f => {
                const name = f.get('name');
                const id = String(f.getId()).padStart(2, '0');
                if (name) globalStateMap[name] = id;
            });

            // 3. Process US Counties
            const countyFormat = new ol.format.TopoJSON({ layers: ['counties'] });
            globalAllCounties = countyFormat.readFeatures(countyData, {
                featureProjection: 'EPSG:3857'
            });

            // 4. Process Int'l Cities
            if (cityData) {
                const cityFormat = new ol.format.GeoJSON();
                globalAllCities = cityFormat.readFeatures(cityData, {
                    featureProjection: 'EPSG:3857'
                });
            }

            loader.style.display = 'none';
            refreshMapLayers();

        }).catch(err => {
            console.error(err);
            loader.innerHTML = "Error loading data. Check console.";
        });
    </script>
    <script type="module">
      import { inject } from '@vercel/analytics';
      inject();
    </script>
</body>
</html>